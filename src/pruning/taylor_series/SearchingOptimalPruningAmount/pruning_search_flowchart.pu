@startuml Pruning Search Algorithm

' Define styles and colors for better visibility
skinparam backgroundColor white
skinparam arrowColor #333333
skinparam activityBorderColor #333333
skinparam activityBackgroundColor #FEFECE
skinparam activityDiamondBorderColor #333333
skinparam activityDiamondBackgroundColor #FEFECE
skinparam partitionBorderColor #333333
skinparam partitionBackgroundColor #FEFECE


title Pruning Search Algorithm Flowchart

' Main Flow
(*) --> "Initialize Parameters\nmin_acc=50.0\nmin_size=30.0" 
--> "Load Initial Model" 
--> "Get Initial Model Info\nSize, Filters, Accuracy" 
--> "Initialize Reward Function" 
--> "Compute Filter Ranks\nusing Taylor criterion"
--> "Initialize CMA-ES\nWith Aggressive Parameters\nStart Point: 0.05\nStep Size: 0.25"
--> "Binary Search Exploration\nPoints: 0.1, 0.25, 0.4, 0.55, 0.7"

' Binary Search Process
partition "Binary Search Phase" {
    "Binary Search Exploration\nPoints: 0.1, 0.25, 0.4, 0.55, 0.7" --> "Evaluate Each Binary Point"
    --> "Sort Results by Reward"
    --> "Select Top 2 Regions"
    --> "Create Promising Regions\nAround Best Points"
}

' Initial Targeted Exploration
"Create Promising Regions\nAround Best Points" --> if "Best Solution Found?" then
    -->[yes] "Create Dense Exploration\nAround Best Point"
else
    -->[no] "Explore Wide Range\n0.05 to 0.7"
endif

"Create Dense Exploration\nAround Best Point" --> "Initial Targeted Exploration"
"Explore Wide Range\n0.05 to 0.7" --> "Initial Targeted Exploration"

' Targeted Exploration Process
partition "Targeted Exploration Phase" {
    "Initial Targeted Exploration" --> "Evaluate Each Point"
    --> "Update Best Solution\nIf Better Found"
    --> "Add New Promising\nRegions"
}

' CMA-ES Iterations
"Add New Promising\nRegions" --> "Start CMA-ES Iterations"

partition "CMA-ES Optimization Phase" {
    "Start CMA-ES Iterations" --> if "Iteration Limit Reached?" then
        -->[yes] "Final Evaluation"
    else
        -->[no] "Ask for Solutions\nfrom CMA-ES"
        --> "Evaluate Each Solution"
        
        "Evaluate Each Solution" --> if "Better Solution Found?" then
            -->[yes] "Update Best Solution"
            --> if "Significant Improvement?" then
                -->[yes] "Immediate Exploration\nAround New Best"
                --> "Add Region to\nPromising List"
                --> "Continue Search"
            else
                -->[no] "Continue Search"
            endif
        else
            -->[no] "Continue Search"
        endif
        
        "Continue Search" --> "Tell Results to CMA-ES"
        --> if "Stagnating?" then
            -->[yes] if "Promising Regions Left?" then
                -->[yes] "Explore Next\nPromising Region"
                --> "Increment Iteration"
            else
                -->[no] "Restart with\nNew Parameters"
                --> "Increment Iteration"
            endif
        else
            -->[no] "Increment Iteration"
            --> "Iteration Limit Reached?"
        endif
    endif
}

' Region Exploration Subprocess
partition "Region Exploration Strategy" {
    (*) -right-> "Set Min/Max Bounds\nAround Center"
    --> "Create Non-Uniform Points\nDenser Near Center"
    --> "Sort Points"
    --> "Evaluate Each Point"
    --> if "Better Than Global Best?" then
        -->[yes] "Update Global Best"
        --> if "Significant Improvement?" then
            -->[yes] "Return Signal for\nSignificant Improvement"
            --> "More Points to Evaluate?"
        else
            -->[no] "More Points to Evaluate?"
        endif
    else
        -->[no] if "More Points to Evaluate?" then
            -->[yes] "Evaluate Each Point"
        else
            -->[no] "Clear Memory"
            --> (*)
        endif
    endif
}

' Final Evaluation
"Final Evaluation" --> if "Best Solution Found?" then
    -->[yes] "Get Pruned Model\nwith Best Amount"
else
    -->[no] "Use Default\nPruning (0.25)"
    --> "Get Pruned Model\nwith Best Amount"
endif

"Get Pruned Model\nwith Best Amount" --> "Full Fine-Tuning\nNo Quick Mode"
--> "Validate Final Model"
--> "Save Model"
--> "Plot Search Results"
--> (*)

' Reward Calculation Process
partition "Reward Calculation Process" {
    (*) --> if "Cached Values?" then
        -->[yes] if "Extreme Pruning?" then
            -->[yes] "Return Low Reward"
            --> (*)
        else
            -->[no] "Create Pruned Model"
        endif
    else
        -->[no] "Initialize Cache"
        --> "Extreme Pruning?"
    endif
    
    "Create Pruned Model" --> "Calculate Parameter Reduction"
    --> if "Enough Filters Left?" then
        -->[no] "Return Low Reward"
        --> (*)
    else
        -->[yes] "Quick Fine-Tuning"
        --> "Validate Model"
        --> "Clean Up Models"
        --> "Get Base Reward"
        --> if "High Pruning & Good Accuracy?" then
            -->[yes] "Add Pruning Bonus"
            --> "Return Final Reward"
            --> (*)
        else
            -->[no] "Return Final Reward"
            --> (*)
        endif
    endif
}

footer
  Pruning Search Algorithm - DDNN Project
endfooter

@enduml